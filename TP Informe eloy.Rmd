---
title: "TP 1: MEAN"
output: html_notebook
author: "Eloy Chang, EmilianoLo Sasso, Federico Rodriguez, Federico Gonzalez"
---

### 1: Descargue los datos de 2018 y a través de gráficos/tabulaciones describa brevemente las principales estadísticas relacionadas al uso de la EcoBici.

```{r,cache=TRUE,echo=FALSE,message=FALSE,warning=FALSE,results='hide'}
library(plotly)
library(dplyr)
library(boot)
library(knitr)
source("../libMEAN.R")

leerDatosRecorridos<- function(dir){
    recorridos<- read.csv(paste(dir,"recorridos-realizados-2018.csv", sep = ""))
    recorridos$fecha_origen_recorrido<- as.POSIXct(as.character(recorridos$fecha_origen_recorrido))
    #recorridos$fecha_destino_recorrido<- as.POSIXct(as.character(recorridos$fecha_destino_recorrido))
    return(recorridos)
}

direccion<- "datasets/" # Direccion en la que se encuentran los datasets
recorridos<- leerDatosRecorridos(direccion)
```

El dataframe a utilizar proviene del gobierno de la Ciudad De Buenos Aires, referente a los recorridos del 2018 realizados con las EcoBicis, el mismo tiene el siguiente formato:

```{r, cache=TRUE,echo=FALSE}
kable(head(recorridos))
```


Veremos la distribución de viajes por genero, donde vemos que la cantidad de viajes realizados por hombres es de `r sum(recorridos$genero_usuario == "M")` mientras que las mujeres realizaron un total de `r sum(recorridos$genero_usuario == "F")` viajes, adicionalmente se encontraron `r sum(recorridos$genero_usuario == "N")` viajes por usuarios que no dieron información de su genero.

```{r,cache=TRUE}
distGenero<- as.data.frame(recorridos %>% group_by(genero_usuario) %>%
                               summarise(cantidad = length(genero_usuario)))
plot_ly(distGenero, x = ~genero_usuario, y = ~cantidad, type = "bar") %>%
    layout(title = "Distribucion de viajes por genero",
           xaxis = list(title = "Genero"), yaxis = list(title = "Numero de viajes"))
```

Otra variable analizada fue la evolución de la cantidad de viajes en el tiempo, donde se aprecia un incremento durant practicamente todo el año y una caida abrupta a partir de finales de Septiembre.

```{r, cache=TRUE}
evoViajes<- as.data.frame(recorridos %>%
                              group_by(fecha = as.Date(fecha_origen_recorrido)) %>%
                              summarise(cantidad = length(fecha_origen_recorrido)))
evoViajes$mediaMovil<- NA
for(i in 10:(nrow(evoViajes) - 10)){
  evoViajes$mediaMovil[i]<- mean(evoViajes$cantidad[(i-9):(i+9)])
}
plot_ly(evoViajes, x = ~fecha, y = ~cantidad, type = "scatter", mode = "line", name = "viajes") %>%
    add_lines(y = ~mediaMovil, name = "Media movil") %>%
    layout(title = "Evolucion de numero de viajes",
           xaxis = list(title = "Fecha"), yaxis = list(title = "Numero de viajes"))
```

Por último se estudio la duración de los viajes, teniendo estos una duración promedio de `r round(mean(as.numeric(recorridos$duracion_recorrido)/60))` minutos.

```{r, cache=TRUE,warning=FALSE,eval=FALSE}
densidadRecorridos<- density(as.numeric(recorridos$duracion_recorrido)/60)
plot_ly(recorridos, x = ~round(as.numeric(recorridos$duracion_recorrido)/60),
        type = "histogram", histnorm = "probability", name = "Distribucion") %>%
    add_lines(x = densidadRecorridos$x, y = densidadRecorridos$y, name = "Densidad") %>%
    layout(title = "Histograma de duracion del recorrido",
           yaxis = list(title = "Distribucion"),
           xaxis = list(title = "Minutos"))
```


### 4: Concéntrese en el usuario 606320. en 2018 realizó 95 recorridos. Elimine los casos en que la estación de origen coincide con la de destino para el mismo recorrido. Queremos calcular la velocidad media a la que usualmente se desplaza este ciclista. Cuando trabajamos con velocidades lo correcto es utilizar la media armónica (y no la media aritmética). Calculando la distancia en bici entre las estaciones (use Google Maps) y con el dato de la duración del recorrido (asumiendo que la persona “no interrumpe el recorrido”, lo cual para este usuario resulta razonable), calcule la velocidad media de circulación de dicho usuario. Comente las ventajas de usar la media armónica en lugar de la media aritmética.

Para encarar este problema primero se realizo un extracto de los datos con información de todos los viajes realizados por este usuario, con la finalidad de obtener los kilómetros entre cada una de las estaciones.

```{r, cache=TRUE}
posUsuario<- recorridos$id_usuario == 606320
recorridosCiclista<- recorridos[posUsuario,] %>%
    group_by(id_estacion_origen,lat_estacion_origen,long_estacion_origen,
             id_estacion_destino,lat_estacion_destino,long_estacion_destino) %>%
    summarise(recorridos = length(id_estacion_origen))
recorridosCiclista<- as.data.frame(recorridosCiclista)
recorridosCiclista<- recorridosCiclista[complete.cases(recorridosCiclista),]
kable(head(recorridosCiclista))
```

Luego se busco la distancia entre cada uno de los puntos en [Google Maps](https://www.google.com.ar/maps), y se agrego esta información al datadrame, y finalmente se calculo la media armónica y la media aritmética de la velocidad para este usuario.

```{r, cache=TRUE}
recorridosCiclista$kilometros<- 0
recorridosCiclista$kilometros[1] <- 3.5
recorridosCiclista$kilometros[2] <- 2.6
recorridosCiclista$kilometros[3] <- 2.1
recorridosCiclista$kilometros[4] <- 2.1
recorridosCiclista$kilometros[5] <- 0.9
recorridosCiclista$kilometros[6] <- 1.5
recorridosCiclista$kilometros[7] <- 3.7
recorridosCiclista$kilometros[8] <- 2.9
recorridosCiclista$kilometros[9] <- 0.9
recorridosCiclista$kilometros[11] <- 2.1
recorridosCiclista$kilometros[12] <- 1.8
recorridosCiclista$kilometros[13] <- 0.65
recorridosCiclista$kilometros[14] <- 3.9
recorridosCiclista$kilometros[15] <- 0.9
recorridosCiclista$kilometros[16] <- 3.0
recorridosCiclista$kilometros[17] <- 1.3
recorridosCiclista$kilometros[18] <- 3.7
recorridosCiclista$kilometros[19] <- 3
recorridosCiclista$kilometros[20] <- 2.9
recorridosCiclista$kilometros[21] <- 2.8
recorridosCiclista$kilometros[22] <- 2.4
recorridosCiclista$kilometros[23] <- 1.1
recorridosCiclista$kilometros[24] <- 3.1
recorridosCiclista$kilometros[25] <- 2.9
recorridosCiclista$kilometros[26] <- 2.9
recorridosCiclista$kilometros[27] <- 2

recorridos$velocidad<- 0
for(pos in which(posUsuario)){
    if(is.na(recorridos$id_estacion_origen[pos]) | is.na(recorridos$id_estacion_destino[pos])){
        next
    }
    duracion<- as.numeric(recorridos$duracion_recorrido[pos])/3600
    posRuta<- recorridosCiclista$id_estacion_origen == recorridos$id_estacion_origen[pos] &
        recorridosCiclista$id_estacion_destino == recorridos$id_estacion_destino[pos]
    kilometros<- recorridosCiclista$kilometros[posRuta]
    recorridos$velocidad[pos]<- kilometros / duracion
}
posUsuario<- posUsuario & recorridos$velocidad > 0
mediaArmonica<- 1/mean(1/recorridos$velocidad[posUsuario])
mediaAritmetica<- mean(recorridos$velocidad[posUsuario])
```

Como es de suponer la media armónica es menor a la aritmética, siendo estas de `round(mediaArmonica,2)` km/h y de `r round(mediaAritmetica,2)` km/h respectivamente.

En estos casos es recomendable usar la media armónica debido a que es menos sensible a los altos valores de la muestra, mientras que le da mayor importancia a los valores pequeños, y, si se ve el histograma de las velocidades, estas suelen tener colas alargadas hacia grandes velocidades las cuales distorcionan la media aritmética.

```{r,cache=TRUE,warning=FALSE}
plot_ly(recorridos[posUsuario,], x = ~velocidad,type = "histogram", histnorm = "probability", 
        name = "Distribución") %>%
    add_lines(x = rep(mediaAritmetica,2), y = c(0,0.32), name = "Media Aritmética") %>%
    add_lines(x = rep(mediaArmonica,2), y = c(0,0.32), name = "Media Armónica")

```

### 7. En mayo de 2018 se inauguró la estación Facultad de Derecho de la línea H de subtes. ¿Afectó esto al uso de la EcoBici por la zona? Evalúe empíricamente si en la estación “001-FACULTAD DE DERECHO” se registró una diferencia estadísticamente significativa en el uso de las EcoBicis antes y después de la inauguración de la estación de subte. Comente.

Para concluir si hay diferencia en el uso de la estación antes y despues de la innaguración de la estación de subte de Facultad de Derecho, se tomo la cantidad de viajes por día (Se asigna un viaje al día en el que este comienza), luego si encontramos una diferencia significativa en la media de viajes por día (se considera un viaje de la estación si este comienza o termina en la estación).

Luego se calculan dos data frame, uno con la información de la cantidad de viajes diarios de la estación los días previos al mes de mayo, y el otro con la cantidad de viajes diarios de la estación desde mayo en adelante. 

```{r, cache=TRUE}
recorridos$facultad_derecho<- recorridos$id_estacion_destino == 1 |
    recorridos$id_estacion_origen == 1
recorridosFacultad<- recorridos %>% filter(!is.na(id_estacion_origen) & !is.na(id_estacion_destino)) %>% filter(facultad_derecho)
recorridosFacultad$mes<- as.POSIXlt(recorridosFacultad$fecha_origen_recorrido)$mon
recorridosFacultad$fecha_origen<- as.Date(recorridosFacultad$fecha_origen_recorrido)
recorridosFacultad$fecha_destino<- as.Date(recorridosFacultad$fecha_destino_recorrido)

recorridosAntes<- recorridosFacultad[recorridosFacultad$mes < 5,]
recorridosDespues<- recorridosFacultad[recorridosFacultad$mes > 4,]

viajesDiariosAntes<- recorridosAntes %>% group_by(fecha_origen) %>%
    summarise(viajes = length(fecha_origen))
viajesDiariosAntes<- as.data.frame(viajesDiariosAntes)
viajesDiariosDespues<- recorridosDespues %>% group_by(fecha_origen) %>%
    summarise(viajes = length(fecha_origen))
viajesDiariosDespues<- as.data.frame(viajesDiariosDespues)
```

La prueba de hipotesis sera:

Hipótesis Nula: La diferencia del promedio de viajes antes y despues de la innaguración de la estación de Subte Facultad de Derecho es igual a 0.

Hipótesis Alternativa: La diferencia del promedio de viajes antes y despues de la innaguración de la estación de Subte Facultad de Derecho es distinta de 0.

Esto se hara con un nivel de significación del 5%

Este test se hara con dos conjuntos de datos, uno tomando solo 4 meses de datos (Marzo y Abril en el primer set de datos, Mayo y Junio en el segundo set de datos), y otro con los 151 días de datos del primer set de datos y los primeros 151 datos del segundo set de datos. En este caso la prueba no es apareada debido a que no es el mismo "sujeto" que se mide antes y despues de la innaguración.

##### Caso de 4 meses

```{r,cache=TRUE}
t.test(viajesDiariosAntes$viajes[92:151],viajesDiariosDespues$viajes[1:60],paired = FALSE,mu = 0, alternative = "two.sided")
```

Para este caso no se encuentra evidencia para rechazar la hipótesis nula, debido a lo alto del p-valor y ademas el 0 esta contenido dentro del intervalo de confianza.

##### Caso de 151 días

```{r,cache=TRUE}
t.test(viajesDiariosAntes$viajes,viajesDiariosDespues$viajes[1:151], paired = FALSE, mu = 0,alternative = "two.sided")
```

En este caso se rechaza la hipótesis nula debido a que el p-valor es menor al nivel de significacíon, por lo tanto decimos que hay evidencia estadística de que la cantidad de viajes diarios es diferente, mas aún, dado el intervalo de confianza podemos decir que la cantidad de viajes por día aumento luego de la innaguración de la estación de Subte.

Como conclusión general podemos decir que si hay un cambio significativo en el uso de la estación de EcoBici antes y depues de la innaguración de la estación de Subte pero el mismo fue paulatino, ya que se requirio tomar muestras de mas días para poder visualizar dicho comportamiento.

###  Bootstrapping: dado que la distribución del coeficiente de correlación no es normal ya que está limitada entre -1 y 1, el método bootstrap puede ser muy útil para hacer inferencia sobre dicho parámetro. Para ello, nos centraremos en la correlación entre la edad del usuario de EcoBici y la duración del recorrido para aquellos individuos que hacen el recorrido “Parque Las Heras - Billingurst” (mismos que en el punto 5 del TP). Siga los siguientes pasos para construir el intervalo de confianza del coeficiente de correlación entre dichas variables: 
### * Defina una función (function()) que permita calcular el estadístico sobre el cual se quiere realizar el bootstrap.
### * Utilice la función boot() usando la base de datos de recorridos y la función generada en el paso anterior para tomar 1.000 muestras con reemplazo.
### * Obtenga el histograma de las estimaciones del bootstrap. Describa.
### * Utilice la función boot.ci() con la opción "perc" y obtenga el intervalo de confianza al 95%. Interprete. ¿Resulta estadísticamente significativa la correlación entre la duración del recorrido y la edad del ciclista?

Antes que nada, para obtener los datos de la edad de los usuarios necesitamos leer los datos de usuarios, para esto vamos los datos de los usuarios del 2018.

```{r, cache=TRUE}
usuarios<- read.csv("datasets/usuarios-ecobici-2018.csv")

cat(paste("Catidad de usuarios en dataframe:",length(unique(recorridos$id_usuario)),
          "\nCatidad de usuarios:",nrow(usuarios),
          "\nCantidad de usuarios en ambos DF:",sum(unique(recorridos$id_usuario) %in% usuarios$usuario_id)))
```

Vemos que en dicho archivo se tienen muy pocos usuarios, luego debemos ir a los archivos de los años previos.

```{r, cache=TRUE}
archivos<- c("datasets/usuarios-ecobici-2017.csv",
             "datasets/usuarios-ecobici-2016.csv",
             "datasets/usuarios-ecobici-2015.csv")
for(archivo in archivos){
    aux<- read.csv(archivo)
    usuarios<- rbind(usuarios,aux)
}

cat(paste("Catidad de usuarios en dataframe:",length(unique(recorridos$id_usuario)),
          "\nCatidad de usuarios:",nrow(usuarios),
          "\nCantidad de usuarios en ambos DF:",sum(unique(recorridos$id_usuario) %in% usuarios$usuario_id)))
```

Con esto obtenemos información de muchos mas usuarios, igualmente nos faltan una cantidad importante de usuarios, pero los archivos de la alta de los mismos no se encotraron disponibles, por lo que trabajaremos solo con los usuarios encontrados. 

Luego generaremos un dataframe con los datos de la edad y la duración de los recorridos de la ruta desde la estación __Parque las Heras__ hasta __Billingurst__.

```{r, cache=TRUE}
datosEdad<- merge(recorridos[recorridos$id_estacion_origen == 9 & recorridos$id_estacion_destino == 66,
                             c("id_usuario","duracion_recorrido")],
                  usuarios[,c("usuario_id","usuario_edad")],
                  by.x = "id_usuario", by.y = "usuario_id")

datosEdad$duracion_recorrido<- as.numeric(datosEdad$duracion_recorrido)

kable(head(datosEdad))
```

Usamos el método de Bootstap para estimar la correlación entre la edad y la duración del recorrido y visualizamos los intervalos de confianza generados. 

```{r, cache=TRUE}
fc_cor <- function(d,i){
    d <- datosEdad[i,]
    return(cor(d$duracion_recorrido,d$usuario_edad))
}

boot_cor <- boot(data = datosEdad, statistic = fc_cor, R = 1000)

boot.ci(boot.out = boot_cor, type = c("norm", "basic", "perc","bca"),)
```

Finalmente, si hacemos foco en el intervalo generado con la opción de percentiles, vemos que la correlación entre la duración de los viajes y la edad del usuario es significativa pero muy baja. 

Ahora veamos los gráficos relevantes para la prueba.

```{r eval=FALSE, warning=FALSE, cache=TRUE}
densidad<- density(boot_cor$t)

muestras<- data.frame(
  id = 1:length(boot_cor$t),
  correlaciones = boot_cor$t
)

plot_ly(muestras, x = ~correlaciones, type = "histogram", histnorm = "probability", name = "Distribución") %>%
    add_lines(x = densidad$x, y = densidad$y/100, name = "Densidad") %>%
    add_lines(x = rep(boot_cor$t0,2), y = c(0, 0.09), name = "Correlación muestral") %>% 
    layout(title = "Histograma de correlaciones Bootstap",
           xaxis = list(title = "Correlación"), yaxis = list(title = "Densidad"))
```

```{r eval=FALSE,fig.height=400, fig.width=600, warning=FALSE, cache=TRUE}
muestras<- muestras[order(muestras$correlaciones),]
muestras$normal<- sort(rnorm(nrow(muestras)))

plot_ly(muestras, x = ~normal, y = ~correlaciones, type = "scatter", mode = "markers") %>%
    layout(title = "QQ Plot", xaxis = list(title = "Quantiles de la Normal estandar"),
           yaxis = list(title = "Correlación"))
```




